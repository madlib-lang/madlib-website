on: [push]
name: build
jobs:
  # build:
  #   runs-on: ubuntu-20.04
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v2

  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v1
  #       with:
  #         username: ${{ secrets.DOCKER_HUB_USERNAME }}
  #         password: ${{ secrets.DOCKER_HUB_TOKEN }}

  #     - name: Set up Docker Buildx
  #       uses: docker/setup-buildx-action@v1

  #     - name: Build and push
  #       uses: docker/build-push-action@v2
  #       with:
  #         context: .
  #         file: ./Dockerfile
  #         push: true
  #         tags: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ secrets.DOCKER_REPOSITORY }}:latest

  deploy:
    # needs: build
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Read docker-compose.yml content
        run: |
          content="$(cat docker-compose.yml)"
          echo "DOCKER_COMPOSE_CONTENT=$content" >> $GITHUB_ENV
          # echo "::set-output name=content::${content//$'\n'/\\n}"
        id: docker-compose

      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo ${{ secrets.SSL_CERTIFICATE }} > cert.crt
            echo ${{ secrets.SSL_CA_BUNDLE }} > cert.ca-bundle
            echo ${{ secrets.SSL_KEY }} > cert.key
            echo ${{ env.DOCKER_COMPOSE_CONTENT }} > docker-compose.yml
            docker-compose pull
            docker-compose up --force-recreate --remove-orphans -d
      # - name: Read docker-compose.yml content
      #   run: |
      #     $content=$(cat docker-compose.yml)
      #     echo "::set-output name=content::${content//$'\n'/\\n}"
      #   id: docker-compose

      # - name: Deploy
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.SSH_HOST }}
      #     username: ${{ secrets.SSH_USERNAME }}
      #     key: ${{ secrets.SSH_KEY }}
      #     script: |
      #       echo ${{ secrets.SSL_CERTIFICATE }} > cert.crt
      #       echo ${{ secrets.SSL_CA_BUNDLE }} > cert.ca-bundle
      #       echo ${{ secrets.SSL_KEY }} > cert.key
      #       echo ${{ steps.docker-compose.outputs.content }} > docker-compose.yml
      #       docker-compose pull
      #       docker-compose up --force-recreate --remove-orphans -d
